# Category（カテゴリー）

## テーブル: categories

商品のカテゴリー分類。階層構造をサポート。

### スキーマ

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | ULID | PRIMARY KEY | カテゴリーID |
| name | string(50) | NOT NULL | カテゴリー名 |
| parent_id | ULID | FOREIGN KEY, NULLABLE | 親カテゴリーID |
| display_order | integer | NOT NULL | 表示順序 |
| created_at | timestamp | NOT NULL | 作成日時 |
| updated_at | timestamp | NOT NULL | 更新日時 |

## ドメイン制約

### 文字数制約

- ✅ `name`は**50文字以内**

### 名前の制約

- ✅ 空白のみの名前は不可
- ✅ 前後の空白は自動でトリミング
- ✅ **同じ親を持つカテゴリー間で名前が重複不可**
  - 例: 「家電」の子に「パソコン」が2つあってはいけない
  - ただし、異なる親であればOK（「家電 > パソコン」と「本 > パソコン」は別物）

### 階層構造

- ✅ `parent_id`が`null`の場合、ルートカテゴリー（第1階層）
- ✅ `parent_id`を指定することで、サブカテゴリーを作成可能
- ✅ **最大3階層まで**（例: 家電 → パソコン → ノートPC）
- ⚠️ 循環参照は不可（自分自身や子孫を親に指定できない）

### 階層ごとのカテゴリー数制約

- ✅ 第1階層（ルート）: **最大20個まで**
- ✅ 第2階層（各親の子）: **各親ごとに最大20個まで**
- ✅ 第3階層（各親の子）: **各親ごとに最大30個まで**

### 表示順序制約

- ✅ `display_order`は**0以上、同階層のカテゴリー数未満**である必要がある
- ✅ 例: 同階層に3つのカテゴリーがある場合、`display_order`は0, 1, 2のいずれか
- ⚠️ 同じ親を持つカテゴリー間で`display_order`は一意である必要がある（重複不可）

### 階層の例

```text
第1階層（ルート）: 家電（最大30個）
  └ 第2階層: パソコン（家電の子として最大30個）
      └ 第3階層: ノートPC（パソコンの子として最大30個）
```

### 削除制約

- ❌ **子カテゴリーが存在する場合は削除不可**
  - 例: 「家電」に子カテゴリー「パソコン」がある場合、「家電」は削除できない
  - 削除するには、まず子カテゴリーをすべて削除する必要がある
- ❌ **商品が紐付いている場合は削除不可**
  - 例: 「パソコン」カテゴリーに商品が1つでも存在する場合、削除できない
  - 削除するには、まず商品をすべて別のカテゴリーに移動または削除する必要がある

### 親カテゴリーの存在チェック

- ✅ `parent_id`を指定する場合、そのカテゴリーが実際に存在する必要がある
- ✅ 存在しない`parent_id`を指定した場合はエラー

### カテゴリー管理

- ⚠️ **カテゴリー管理UIは実装しない**（PRDより）
- カテゴリーは固定値として扱う（マスタデータ）

## リレーション

- **1:N** → Products（カテゴリーは複数の商品を持つ）
- **1:N** → Categories（親カテゴリーは複数の子カテゴリーを持つ）
- **N:1** → Category（子カテゴリーは1つの親カテゴリーに属する）
